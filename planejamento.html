<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸ“… Planejamento Mensal</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ðŸ“… Planejamento Mensal</h1>

  <form id="planejamentoForm">
    <label for="mes">MÃªs:</label>
    <input type="month" name="mes" required />

    <label for="receitas">PrevisÃ£o de Receitas:</label>
    <input type="text" id="receitas" required />

    <label for="despesas">PrevisÃ£o de Despesas:</label>
    <input type="text" id="despesas" required />

    <button type="submit">Salvar</button>
  </form>

  <div id="graficoContainer">
    <h2 id="tituloMes">GrÃ¡fico de Planejamento</h2>
    <canvas id="graficoPizza"></canvas>
    <p id="resultadoSaldo"></p>
  </div>

  <div>
    <h2>ðŸ“Š HistÃ³rico de Planejamento</h2>
    <table border="1">
      <thead>
        <tr>
          <th>MÃªs</th>
          <th>Receitas</th>
          <th>Despesas</th>
          <th>Saldo</th>
        </tr>
      </thead>
      <tbody id="tabelaHistorico"></tbody>
    </table>
  </div>

  <script>
    const receitasInput = document.getElementById("receitas");
    const despesasInput = document.getElementById("despesas");
    const form = document.getElementById("planejamentoForm");
    const graficoContainer = document.getElementById("graficoContainer");
    const tituloMes = document.getElementById("tituloMes");
    const resultadoSaldo = document.getElementById("resultadoSaldo");
    const tabelaHistorico = document.querySelector("#tabelaHistorico");
    const ctx = document.getElementById("graficoPizza").getContext("2d");
    let grafico;

    function formatarMoeda(input) {
      let valor = input.value.replace(/\D/g, "");
      if (valor === "") {
        input.value = "";
        return;
      }
      valor = (parseInt(valor) / 100).toFixed(2);
      input.value = parseFloat(valor).toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL",
      });
    }

    [receitasInput, despesasInput].forEach(input => {
      input.addEventListener("input", () => formatarMoeda(input));
    });

    function moedaParaNumero(valor) {
      if (!valor) return 0;
      return parseFloat(
        valor.replace(/\s/g, "").replace("R$", "").replace(/\./g, "").replace(",", ".")
      ) || 0;
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const mes = form.elements["mes"].value;
      const receitas = moedaParaNumero(receitasInput.value);
      const despesas = moedaParaNumero(despesasInput.value);

      if (!mes || isNaN(receitas) || isNaN(despesas)) {
        alert("Preencha todos os campos corretamente.");
        return;
      }

      const historico = JSON.parse(localStorage.getItem("planejamentos")) || [];
      historico.push({ mes, receitas, despesas });
      localStorage.setItem("planejamentos", JSON.stringify(historico));

      atualizarHistorico();
      mostrarGrafico(mes, receitas, despesas);
      mostrarSaldo(receitas - despesas);

      form.reset();
    });

    function atualizarHistorico() {
      const historico = JSON.parse(localStorage.getItem("planejamentos")) || [];
      tabelaHistorico.innerHTML = "";

      historico.forEach(({ mes, receitas, despesas }) => {
        const [ano, mesNum] = mes.split("-");
        const nomeMes = new Date(`${ano}-${mesNum}-01`).toLocaleString("pt-BR", { month: "long" });

        const saldo = receitas - despesas;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${nomeMes}/${ano}</td>
          <td>${receitas.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
          <td>${despesas.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
          <td>${saldo.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
        `;
        tabelaHistorico.appendChild(tr);
      });
    }

    function mostrarGrafico(mes, receitas, despesas) {
      const [ano, mesNum] = mes.split("-");
      const nomeMes = new Date(`${ano}-${mesNum}-01`).toLocaleString("pt-BR", { month: "long" });
      tituloMes.textContent = `GrÃ¡fico de ${nomeMes}/${ano}`;

      if (grafico) grafico.destroy();

      grafico = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Receitas", "Despesas"],
          datasets: [{
            data: [receitas, despesas],
            backgroundColor: ["#4CAF50", "#F44336"],
          }],
        },
      });
    }

    function mostrarSaldo(saldo) {
      resultadoSaldo.textContent = `Saldo: ${saldo.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL",
      })}`;
      resultadoSaldo.style.color = saldo >= 0 ? "green" : "red";
    }

    document.addEventListener("DOMContentLoaded", () => {
      atualizarHistorico();
    });
  </script>
</body>
</html>
