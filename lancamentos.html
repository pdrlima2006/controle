<script>
  const form = document.getElementById('transacaoForm');
  const lista = document.getElementById('listaTransacoes');
  const inputFiltroMes = document.getElementById('filtroMes');
  const saldoMesEl = document.getElementById('saldoDoMes');
  let grafico;

  function formatarValor(valor) {
    return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function formatarDataBR(dataISO) {
    const d = new Date(dataISO);
    return d.toLocaleDateString('pt-BR');
  }

  function atualizarLista(transacoes) {
    lista.innerHTML = '';
    transacoes.forEach((t) => {
      const li = document.createElement('li');
      li.textContent = `${t.data} - ${t.tipo.toUpperCase()} de ${formatarValor(Number(t.valor))} (${t.descricao})`;
      if (t.notaFiscalNome) {
        const link = document.createElement('a');
        link.href = t.notaFiscalBase64;
        link.download = t.notaFiscalNome;
        link.textContent = ' 📎 Ver Nota Fiscal';
        link.style.marginLeft = '10px';
        li.appendChild(link);
      }
      lista.appendChild(li);
    });
  }

  function atualizarGrafico(transacoes) {
    // Se quiser manter o gráfico, pode deixar aqui (opcional)
  }

  function carregarDados() {
    const transacoes = JSON.parse(localStorage.getItem('transacoes')) || [];
    atualizarLista(transacoes);
    // atualizarGrafico(transacoes); // opcional
  }

  function filtrarPorMes() {
    const mesSelecionado = inputFiltroMes.value;
    if (!mesSelecionado) {
      alert('Selecione um mês válido!');
      return;
    }

    saldoMesEl.textContent = '';

    const [ano, mes] = mesSelecionado.split("-");
    const transacoes = JSON.parse(localStorage.getItem('transacoes')) || [];

    const filtradas = transacoes.filter(t => {
      const [anoT, mesT] = t.data.split('-');
      return anoT === ano && mesT === mes;
    });

    atualizarLista(filtradas);
    // atualizarGrafico(filtradas); // opcional
  }

  function mostrarSaldoMes() {
    const mesSelecionado = inputFiltroMes.value;
    if (!mesSelecionado) {
      alert("Selecione um mês primeiro.");
      return;
    }

    const [ano, mes] = mesSelecionado.split("-");
    const transacoes = JSON.parse(localStorage.getItem('transacoes')) || [];

    const filtradas = transacoes.filter(t => {
      const [anoT, mesT] = t.data.split('-');
      return anoT === ano && mesT === mes;
    });

    const entradas = filtradas.filter(t => t.tipo === 'entrada').reduce((s, t) => s + Number(t.valor), 0);
    const saidas = filtradas.filter(t => t.tipo === 'saida').reduce((s, t) => s + Number(t.valor), 0);
    const saldo = entradas - saidas;

    saldoMesEl.textContent = `Saldo do mês: ${formatarValor(saldo)} (${formatarValor(entradas)} - ${formatarValor(saidas)})`;
  }

  function nomeMesPorExtenso(mes) {
    const meses = [
      "JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO",
      "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"
    ];
    return meses[parseInt(mes, 10) - 1];
  }

  function gerarPdfDoMes() {
    const mesSelecionado = inputFiltroMes.value;
    if (!mesSelecionado) {
      alert("Selecione um mês para gerar o PDF.");
      return;
    }

    const [ano, mes] = mesSelecionado.split("-");
    const transacoes = JSON.parse(localStorage.getItem('transacoes')) || [];

    const filtradas = transacoes.filter(t => {
      const [anoT, mesT] = t.data.split('-');
      return anoT === ano && mesT === mes;
    });

    if (filtradas.length === 0) {
      alert("Não há transações para o mês selecionado.");
      return;
    }

    const entradas = filtradas.filter(t => t.tipo === 'entrada').reduce((s, t) => s + Number(t.valor), 0);
    const saidas = filtradas.filter(t => t.tipo === 'saida').reduce((s, t) => s + Number(t.valor), 0);
    const saldo = entradas - saidas;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Cabeçalho
    doc.setFontSize(18);
    doc.setFont("helvetica", "bold");
    const titulo = `RELATÓRIO DO MÊS DE ${nomeMesPorExtenso(mes)} DE ${ano}`;
    doc.text(titulo, 14, 20);

    // Linha horizontal abaixo do título
    doc.setLineWidth(0.5);
    doc.line(14, 24, 196, 24);

    // Espaço inicial para tabela
    let y = 32;

    // Cabeçalho tabela
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("DATA", 14, y);
    doc.text("TIPO", 50, y);
    doc.text("VALOR", 90, y);
    doc.text("DESCRIÇÃO", 130, y);
    y += 8;
    doc.setFont("helvetica", "normal");

    // Conteúdo tabela
    filtradas.forEach((t) => {
      if (y > 280) { // nova página
        doc.addPage();
        y = 20;
      }
      doc.text(formatarDataBR(t.data), 14, y);
      doc.text(t.tipo.toUpperCase(), 50, y);
      doc.text(formatarValor(Number(t.valor)), 90, y);
      doc.text(t.descricao, 130, y, { maxWidth: 60 });
      y += 8;
    });

    // Linha horizontal antes do saldo
    if (y > 280) {
      doc.addPage();
      y = 20;
    }
    y += 8;
    doc.setLineWidth(0.5);
    doc.line(14, y, 196, y);
    y += 8;

    // Saldo final
    doc.setFont("helvetica", "bold");
    doc.text(`ENTRADAS: ${formatarValor(entradas)}`, 14, y);
    y += 8;
    doc.text(`SAÍDAS: ${formatarValor(saidas)}`, 14, y);
    y += 8;
    doc.text(`SALDO DO MÊS: ${formatarValor(saldo)}`, 14, y);

    // Salvar PDF
    doc.save(`relatorio_${ano}-${mes}.pdf`);
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();

    const tipo = form.tipo.value;
    const valor = parseFloat(form.valor.value);
    const descricao = form.descricao.value;
    const data = form.data.value;
    const nova = { tipo, valor, descricao, data };

    const arquivo = form.notaFiscal.files[0];
    if (arquivo) {
      const reader = new FileReader();
      reader.onload = () => {
        nova.notaFiscalBase64 = reader.result;
        nova.notaFiscalNome = arquivo.name;
        salvarTransacao(nova);
      };
      reader.readAsDataURL(arquivo);
    } else {
      salvarTransacao(nova);
    }
  });

  function salvarTransacao(nova) {
    const transacoes = JSON.parse(localStorage.getItem('transacoes')) || [];
    transacoes.push(nova);
    localStorage.setItem('transacoes', JSON.stringify(transacoes));
    form.reset();
    carregarDados();
  }

  document.addEventListener('DOMContentLoaded', carregarDados);
</script>
